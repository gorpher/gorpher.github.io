<!DOCTYPE html><html><head><meta charset="utf-8"><title>blog/linux/linux安装mongodb集群 | 大道至简</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="icon" href="http://img.matosiki.site/favicon.svg"><link rel="stylesheet" href="../../../css/style.css"><link rel="stylesheet" href="../../../css/search.css"><link rel="stylesheet" href="../../../js/google-code-prettify/tomorrow-night-eighties.min.css"><link rel="stylesheet" href="../../../http:/cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><header> <a id="logo" href="/" title="大道至简"><img src="http://img.matosiki.site/favicon.svg" alt="大道至简"></a><i class="js-toggle-search iconfont icon-search"></i><form class="js-search search-form search-form--modal" role="search"><div class="search-form__inner"><div><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div> <input id="algolia-search-input" class="text-input algolia-search-input" placeholder="你想知道什么?" type="search"><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div></form><a id="nav-toggle" href="#"><span></span></a><nav><div class="menu-top-container"><ul id="menu-top" class="menu"><li class="current-menu-item"> <a href="http://www.matosiki.site/" target="_self">首页</a></li><li class="current-menu-item"> <a href="./bash" target="_self">bash教程</a></li></ul></div></nav></header><div class="m-header"><section id="hero1" class="hero"><div class="inner"></div></section><figure class="top-image" data-enable="true"></figure></div><div class="wrapper" id="wrapper"><article><h1 class="post-title" itemprop="name"> blog/linux/linux安装mongodb集群</h1><div class="post-body mb"><h1 id="linux安装mongodb集群"><a href="#linux安装mongodb集群" class="headerlink" title="linux安装mongodb集群"></a>linux安装mongodb集群</h1><h1 id="1、相关概念"><a href="#1、相关概念" class="headerlink" title="1、相关概念"></a>1、相关概念</h1><p><img src="http://www.ityouknow.com/assets/images/2017/bigdata/sharded-cluster-production-architecture.bakedsvg.svg" alt="img"></p><p>从图中可以看到有四个组件：mongos、config server、shard、replica set。</p><p>mongos，数据库集群请求的入口，所有的请求都通过mongos进行协调，不需要在应用程序添加一个路由选择器，mongos自己就是一个请求分发中心，它负责把对应的数据请求请求转发到对应的shard服务器上。在生产环境通常有多mongos作为请求的入口，防止其中一个挂掉所有的mongodb请求都没有办法操作。</p><p>config server，配置服务器，存储所有数据库元信息（路由、分片）的配置。mongos本身没有物理存储分片服务器和数据路由信息，只是缓存在内存里，配置服务器则实际存储这些数据。mongos第一次启动或者关掉重启就会从 config server 加载配置信息，以后如果配置服务器信息变化会通知到所有的 mongos 更新自己的状态，这样 mongos 就能继续准确路由。在生产环境通常有多个 config server 配置服务器，因为它存储了分片路由的元数据，防止数据丢失！</p><p>shard，分片（sharding）是指将数据库拆分，将其分散在不同的机器上的过程。将数据分散到不同的机器上，不需要功能强大的服务器就可以存储更多的数据和处理更大的负载。基本思想就是将集合切成小块，这些块分散到若干片里，每个片只负责总数据的一部分，最后通过一个均衡器来对各个分片进行均衡（数据迁移）。</p><p>replica set，中文翻译副本集，其实就是shard的备份，防止shard挂掉之后数据丢失。复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。</p><p>仲裁者（Arbiter），是复制集中的一个MongoDB实例，它并不保存数据。仲裁节点使用最小的资源并且不要求硬件设备，不能将Arbiter部署在同一个数据集节点中，可以部署在其他应用服务器或者监视服务器中，也可部署在单独的虚拟机中。为了确保复制集中有奇数的投票成员（包括primary），需要添加仲裁节点做为投票，否则primary不能运行时不会自动切换primary。</p><p>简单了解之后，我们可以这样总结一下，应用请求mongos来操作mongodb的增删改查，配置服务器存储数据库元信息，并且和mongos做同步，数据最终存入在shard（分片）上，为了防止数据丢失同步在副本集中存储了一份，仲裁在数据存储到分片的时候决定存储到哪个节点。</p><h1 id="2、环境准备"><a href="#2、环境准备" class="headerlink" title="2、环境准备"></a>2、环境准备</h1><p>系统系统 <strong>centos7</strong><br>五台服务器：<strong>10.253.173.95、10.253.173.108、10.253.164.220、10.253.164.242、10.253.164.244</strong><br>安装包： <strong>mongodb-linux-x86_64-3.4.6.tgz</strong></p><p>服务器规划</p><table><thead><tr><th>95</th><th>108</th><th>220</th><th>242</th><th>244</th></tr></thead><tbody><tr><td>mongos</td><td>mongos</td><td></td><td></td><td></td></tr><tr><td>config server</td><td>config server</td><td>config server</td><td></td><td></td></tr><tr><td>sshard1 server</td><td>shard2 server</td><td>shard3 server</td><td>shard4 server</td><td>shard5 server</td></tr><tr><td>shard5 server</td><td>shard1 server</td><td>shard2 server</td><td>shard3 server</td><td>shard4 server</td></tr><tr><td>shard4 server</td><td>shard5 server</td><td>shard1 server</td><td>shard2 server</td><td>shard3 server</td></tr></tbody></table><p>端口分配：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongos：20000</span><br><span class="line">config：21000</span><br><span class="line">shard1：27001</span><br><span class="line">shard2：27002</span><br><span class="line">shard3：27003</span><br><span class="line">shard4：27004</span><br><span class="line">shard5：27005</span><br></pre></td></tr></table></figure><h1 id="3、集群搭建"><a href="#3、集群搭建" class="headerlink" title="3、集群搭建"></a>3、集群搭建</h1><h2 id="3-1、安装mongodb"><a href="#3-1、安装mongodb" class="headerlink" title="3.1、安装mongodb"></a>3.1、安装mongodb</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">下载</span><br><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.4.6.tgz</span><br><span class="line"><span class="comment">#解压</span></span><br><span class="line">tar -xzvf mongodb-linux-x86_64-3.4.6.tgz -C /opt/</span><br><span class="line"><span class="comment">#重命名</span></span><br><span class="line">mv mongodb-linux-x86_64-3.4.6 mongodb</span><br></pre></td></tr></table></figure><p>分别在每台机器建立conf、mongos、config、shard1、shard2、shard3六个目录，因为mongos不存储数据，只需要建立日志文件目录即可。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir -p /mnt/mongodb/conf</span><br><span class="line">mkdir -p /mnt/mongodb/mongos/<span class="built_in">log</span></span><br><span class="line">mkdir -p /mnt/mongodb/config/data</span><br><span class="line">mkdir -p /mnt/mongodb/config/<span class="built_in">log</span></span><br><span class="line">mkdir -p /mnt/mongodb/shard1/data</span><br><span class="line">mkdir -p /mnt/mongodb/shard1/<span class="built_in">log</span></span><br><span class="line">mkdir -p /mnt/mongodb/shard2/data</span><br><span class="line">mkdir -p /mnt/mongodb/shard2/<span class="built_in">log</span></span><br><span class="line">mkdir -p /mnt/mongodb/shard3/data</span><br><span class="line">mkdir -p /mnt/mongodb/shard3/<span class="built_in">log</span></span><br><span class="line">mkdir -p /mnt/mongodb/shard4/data</span><br><span class="line">mkdir -p /mnt/mongodb/shard4/<span class="built_in">log</span></span><br><span class="line">mkdir -p /mnt/mongodb/shard5/data</span><br><span class="line">mkdir -p /mnt/mongodb/shard5/<span class="built_in">log</span></span><br></pre></td></tr></table></figure><p>配置环境变量<strong>vim /etc/profile</strong></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> MONGODB_HOME=/opt/mongodb</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$MONGODB_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><p>环境变量生效</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h2 id="3-2、config-server配置服务器"><a href="#3-2、config-server配置服务器" class="headerlink" title="3.2、config server配置服务器"></a>3.2、config server配置服务器</h2><p>mongodb3.4以后要求配置服务器也创建副本集，不然集群搭建不成功。</p><p>添加配置文件<strong>vi /mnt/mongodb/conf/config.conf</strong>,其中bindIp替换为对应机器的ip</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统日志</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mnt/mongodb/config/log/config.log</span> <span class="comment">#日志存储位置</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 文件存储</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/mnt/mongodb/config/</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">directoryPerDB:</span> <span class="literal">true</span>           <span class="comment">#是否一个库一个文件夹    </span></span><br><span class="line">  <span class="attr">engine:</span> <span class="string">wiredTiger</span>             <span class="comment">#数据引擎   </span></span><br><span class="line">  <span class="attr">wiredTiger:</span>                    <span class="comment">#WT引擎配置</span></span><br><span class="line">    <span class="attr">engineConfig:</span></span><br><span class="line">       <span class="attr">cacheSizeGB:</span> <span class="number">4</span>            <span class="comment">#设置为4G,默认为物理内存的一半</span></span><br><span class="line">       <span class="attr">directoryForIndexes:</span> <span class="literal">true</span> <span class="comment">#是否将索引也按数据库名单独存储</span></span><br><span class="line">       <span class="attr">journalCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">collectionConfig:</span>            <span class="comment">#表压缩配置</span></span><br><span class="line">       <span class="attr">blockCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">indexConfig:</span>                 <span class="comment">#索引配置</span></span><br><span class="line">       <span class="attr">prefixCompression:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置启动管理方式</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mnt/mongodb/config/log/configsrv.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 网络接口</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">21000</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">10.253</span><span class="number">.173</span><span class="number">.95</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 副本集</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">config</span>        </span><br><span class="line"></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">configsvr</span></span><br></pre></td></tr></table></figure><p>启动三台服务器的config server</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mongod -f /mnt/mongodb/conf/config.conf</span><br></pre></td></tr></table></figure><p>登录任意一台配置服务器，初始化配置副本集</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#连接</span></span><br><span class="line">mongo 10.253.173.95:21000</span><br><span class="line"><span class="comment">#config变量</span></span><br><span class="line">config = &#123;</span><br><span class="line">    _id : <span class="string">"config"</span>,</span><br><span class="line">     members : [</span><br><span class="line">         &#123;_id : 0, host : <span class="string">"10.253.173.95:21000"</span> &#125;,</span><br><span class="line">         &#123;_id : 1, host : <span class="string">"10.253.173.108:21000"</span> &#125;,</span><br><span class="line">         &#123;_id : 2, host : <span class="string">"10.253.164.220:21000"</span> &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化副本集</span></span><br><span class="line">rs.initiate(config)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看分区状态</span></span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure><h2 id="3-3、配置分片副本集"><a href="#3-3、配置分片副本集" class="headerlink" title="3.3、配置分片副本集"></a>3.3、配置分片副本集</h2><h3 id="3-1、设置第一个分片副本集"><a href="#3-1、设置第一个分片副本集" class="headerlink" title="3.1、设置第一个分片副本集"></a>3.1、设置第一个分片副本集</h3><p>在服务器上，10.253.173.95、10.253.173.108、10.253.164.220</p><p>配置文件：<strong>vi /mnt/mongodb/conf/shard1.conf</strong>，其中bindIp换成对应机器的ip</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 配置文件内容</span></span><br><span class="line"><span class="comment"># 系统日志</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mnt/mongodb/shard1/log/shard1.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 文件存储</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/mnt/mongodb/shard1/data</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">wiredTiger:</span>                    <span class="comment">#WT引擎配置</span></span><br><span class="line">    <span class="attr">engineConfig:</span></span><br><span class="line">       <span class="attr">cacheSizeGB:</span> <span class="number">4</span>            <span class="comment">#设置为4G,默认为物理内存的一半</span></span><br><span class="line">       <span class="attr">directoryForIndexes:</span> <span class="literal">true</span> <span class="comment">#是否将索引也按数据库名单独存储</span></span><br><span class="line">       <span class="attr">journalCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">collectionConfig:</span>            <span class="comment">#表压缩配置</span></span><br><span class="line">       <span class="attr">blockCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">indexConfig:</span>                 <span class="comment">#索引配置</span></span><br><span class="line">       <span class="attr">prefixCompression:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进程</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mnt/mongodb/shard1/log/shard1.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 网络接口</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27001</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">10.253</span><span class="number">.173</span><span class="number">.95</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 副本集</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard1</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure><p>启动三台服务器的shard1 server</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mongod -f /mnt/mongodb/conf/shard1.conf</span><br></pre></td></tr></table></figure><p>登陆任意一台服务器，初始化副本集</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mongo 10.253.173.95:27001</span><br><span class="line"><span class="comment">#使用admin数据库</span></span><br><span class="line">use admin</span><br><span class="line"><span class="comment">#定义副本集配置</span></span><br><span class="line">config = &#123;</span><br><span class="line">    _id : <span class="string">"shard1"</span>,</span><br><span class="line">     members : [</span><br><span class="line">         &#123;_id : 0, host : <span class="string">"10.253.173.95:27001"</span> &#125;,</span><br><span class="line">         &#123;_id : 1, host : <span class="string">"10.253.173.108:27001"</span> &#125;,</span><br><span class="line">         &#123;_id : 2, host : <span class="string">"10.253.164.220:27001"</span> &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化副本集配置</span></span><br><span class="line">rs.initiate(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看分区状态</span></span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure><h3 id="3-2、设置第二个分片副本集"><a href="#3-2、设置第二个分片副本集" class="headerlink" title="3.2、设置第二个分片副本集"></a>3.2、设置第二个分片副本集</h3><p>在服务器上，10.253.173.108、10.253.164.220、10.253.164.242</p><p>配置文件：<strong>vi /mnt/mongodb/conf/shard2.conf</strong>，其中bindIp换成对应机器的ip</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 配置文件内容</span><br><span class="line"># 系统日志</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: &#x2F;mnt&#x2F;mongodb&#x2F;shard2&#x2F;log&#x2F;shard2.log</span><br><span class="line"> </span><br><span class="line"># 文件存储</span><br><span class="line">storage:</span><br><span class="line">  dbPath: &#x2F;mnt&#x2F;mongodb&#x2F;shard2&#x2F;data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">  wiredTiger:                    #WT引擎配置</span><br><span class="line">    engineConfig:</span><br><span class="line">       cacheSizeGB: 4            #设置为4G,默认为物理内存的一半</span><br><span class="line">       directoryForIndexes: true #是否将索引也按数据库名单独存储</span><br><span class="line">       journalCompressor: zlib</span><br><span class="line">    collectionConfig:            #表压缩配置</span><br><span class="line">       blockCompressor: zlib</span><br><span class="line">    indexConfig:                 #索引配置</span><br><span class="line">       prefixCompression: true</span><br><span class="line"></span><br><span class="line"># 进程</span><br><span class="line">processManagement:</span><br><span class="line">  fork: true </span><br><span class="line">  pidFilePath: &#x2F;mnt&#x2F;mongodb&#x2F;shard2&#x2F;log&#x2F;shard2.pid</span><br><span class="line"> </span><br><span class="line"># 网络接口</span><br><span class="line">net:</span><br><span class="line">  port: 27002</span><br><span class="line">  bindIp: 10.253.173.108</span><br><span class="line"></span><br><span class="line"># 副本集</span><br><span class="line">replication:</span><br><span class="line">    replSetName: shard2</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>启动三台服务器的shard2 server</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongod -f &#x2F;mnt&#x2F;mongodb&#x2F;conf&#x2F;shard2.conf</span><br></pre></td></tr></table></figure><p>登陆任意一台服务器，初始化副本集</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongo 10.253.173.108:27002</span><br><span class="line">#使用admin数据库</span><br><span class="line">use admin</span><br><span class="line">#定义副本集配置</span><br><span class="line">config &#x3D; &#123;</span><br><span class="line">    _id : &quot;shard2&quot;,</span><br><span class="line">     members : [</span><br><span class="line">         &#123;_id : 0, host : &quot;10.253.173.108:27002&quot; &#125;,</span><br><span class="line">         &#123;_id : 1, host : &quot;10.253.164.220:27002&quot; &#125;,</span><br><span class="line">         &#123;_id : 2, host : &quot;10.253.164.242:27002&quot; &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">#初始化副本集配置</span><br><span class="line">rs.initiate(config);</span><br><span class="line"></span><br><span class="line">#查看分区状态</span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure><h3 id="3-3、设置第三个分片副本集"><a href="#3-3、设置第三个分片副本集" class="headerlink" title="3.3、设置第三个分片副本集"></a>3.3、设置第三个分片副本集</h3><p>在服务器上，10.253.164.220、10.253.164.242、10.253.164.244</p><p>配置文件：<strong>vi /mnt/mongodb/conf/shard3.conf</strong>，其中bindIp换成对应机器的ip</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 配置文件内容</span><br><span class="line"># 系统日志</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: &#x2F;mnt&#x2F;mongodb&#x2F;shard3&#x2F;log&#x2F;shard3.log</span><br><span class="line"> </span><br><span class="line"># 文件存储</span><br><span class="line">storage:</span><br><span class="line">  dbPath: &#x2F;mnt&#x2F;mongodb&#x2F;shard3&#x2F;data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">  wiredTiger:                    #WT引擎配置</span><br><span class="line">    engineConfig:</span><br><span class="line">       cacheSizeGB: 4            #设置为4G,默认为物理内存的一半</span><br><span class="line">       directoryForIndexes: true #是否将索引也按数据库名单独存储</span><br><span class="line">       journalCompressor: zlib</span><br><span class="line">    collectionConfig:            #表压缩配置</span><br><span class="line">       blockCompressor: zlib</span><br><span class="line">    indexConfig:                 #索引配置</span><br><span class="line">       prefixCompression: true</span><br><span class="line"># 进程</span><br><span class="line">processManagement:</span><br><span class="line">  fork: true </span><br><span class="line">  pidFilePath: &#x2F;mnt&#x2F;mongodb&#x2F;shard3&#x2F;log&#x2F;shard3.pid</span><br><span class="line"> </span><br><span class="line"># 网络接口</span><br><span class="line">net:</span><br><span class="line">  port: 27003</span><br><span class="line">  bindIp: 10.253.164.220</span><br><span class="line"></span><br><span class="line"># 副本集</span><br><span class="line">replication:</span><br><span class="line">    replSetName: shard3</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>启动三台服务器的shard3 server</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongod -f &#x2F;mnt&#x2F;mongodb&#x2F;conf&#x2F;shard3.conf</span><br></pre></td></tr></table></figure><p>登陆任意一台服务器，初始化副本集</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mongo 10.253.164.220:27003</span><br><span class="line"><span class="comment">#使用admin数据库</span></span><br><span class="line">use admin</span><br><span class="line"><span class="comment">#定义副本集配置</span></span><br><span class="line">config = &#123;</span><br><span class="line">    _id : <span class="string">"shard3"</span>,</span><br><span class="line">     members : [</span><br><span class="line">         &#123;_id : 0, host : <span class="string">"10.253.164.220:27003"</span> &#125;,</span><br><span class="line">         &#123;_id : 1, host : <span class="string">"10.253.164.242:27003"</span> &#125;,</span><br><span class="line">         &#123;_id : 2, host : <span class="string">"10.253.164.244:27003"</span> &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化副本集配置</span></span><br><span class="line">rs.initiate(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看分区状态</span></span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure><h3 id="3-4、设置第四个分片副本集"><a href="#3-4、设置第四个分片副本集" class="headerlink" title="3.4、设置第四个分片副本集"></a>3.4、设置第四个分片副本集</h3><p>在服务器上，10.253.164.242、10.253.164.244、10.253.173.95</p><p>配置文件：<strong>vi /mnt/mongodb/conf/shard4.conf</strong>，其中bindIp换成对应机器的ip</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 配置文件内容</span></span><br><span class="line"><span class="comment"># 系统日志</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mnt/mongodb/shard4/log/shard4.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 文件存储</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/mnt/mongodb/shard4/data</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">wiredTiger:</span>                    <span class="comment">#WT引擎配置</span></span><br><span class="line">    <span class="attr">engineConfig:</span></span><br><span class="line">       <span class="attr">cacheSizeGB:</span> <span class="number">4</span>            <span class="comment">#设置为4G,默认为物理内存的一半</span></span><br><span class="line">       <span class="attr">directoryForIndexes:</span> <span class="literal">true</span> <span class="comment">#是否将索引也按数据库名单独存储</span></span><br><span class="line">       <span class="attr">journalCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">collectionConfig:</span>            <span class="comment">#表压缩配置</span></span><br><span class="line">       <span class="attr">blockCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">indexConfig:</span>                 <span class="comment">#索引配置</span></span><br><span class="line">       <span class="attr">prefixCompression:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进程</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mnt/mongodb/shard4/log/shard4.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 网络接口</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27004</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">10.253</span><span class="number">.164</span><span class="number">.242</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 副本集</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard4</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure><p>启动三台服务器的shard4 server</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongod -f &#x2F;mnt&#x2F;mongodb&#x2F;conf&#x2F;shard4.conf</span><br></pre></td></tr></table></figure><p>登陆任意一台服务器，初始化副本集</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongo 10.253.164.242:27004</span><br><span class="line">#使用admin数据库</span><br><span class="line">use admin</span><br><span class="line">#定义副本集配置</span><br><span class="line">config &#x3D; &#123;</span><br><span class="line">    _id : &quot;shard4&quot;,</span><br><span class="line">     members : [</span><br><span class="line">         &#123;_id : 0, host : &quot;10.253.164.242:27004&quot; &#125;,</span><br><span class="line">         &#123;_id : 1, host : &quot;10.253.164.244:27004&quot; &#125;,</span><br><span class="line">         &#123;_id : 2, host : &quot;10.253.173.95:27004&quot; &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">#初始化副本集配置</span><br><span class="line">rs.initiate(config);</span><br><span class="line"></span><br><span class="line">#查看分区状态</span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure><h3 id="3-5、设置第五个分片副本集"><a href="#3-5、设置第五个分片副本集" class="headerlink" title="3.5、设置第五个分片副本集"></a>3.5、设置第五个分片副本集</h3><p>在服务器上，10.253.164.244、10.253.173.95、10.253.173.108</p><p>配置文件：<strong>vi /mnt/mongodb/conf/shard5.conf</strong>，其中bindIp换成对应机器的ip</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 配置文件内容</span></span><br><span class="line"><span class="comment"># 系统日志</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mnt/mongodb/shard5/log/shard5.log</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 文件存储</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/mnt/mongodb/shard5/data</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">wiredTiger:</span>                    <span class="comment">#WT引擎配置</span></span><br><span class="line">    <span class="attr">engineConfig:</span></span><br><span class="line">       <span class="attr">cacheSizeGB:</span> <span class="number">4</span>            <span class="comment">#设置为4G,默认为物理内存的一半</span></span><br><span class="line">       <span class="attr">directoryForIndexes:</span> <span class="literal">true</span> <span class="comment">#是否将索引也按数据库名单独存储</span></span><br><span class="line">       <span class="attr">journalCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">collectionConfig:</span>            <span class="comment">#表压缩配置</span></span><br><span class="line">       <span class="attr">blockCompressor:</span> <span class="string">zlib</span></span><br><span class="line">    <span class="attr">indexConfig:</span>                 <span class="comment">#索引配置</span></span><br><span class="line">       <span class="attr">prefixCompression:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进程</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/mnt/mongodb/shard5/log/shard5.pid</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 网络接口</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27005</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">10.253</span><span class="number">.164</span><span class="number">.244</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 副本集</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">    <span class="attr">replSetName:</span> <span class="string">shard5</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">    <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br></pre></td></tr></table></figure><p>启动三台服务器的shard5 server</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongod -f &#x2F;mnt&#x2F;mongodb&#x2F;conf&#x2F;shard5.conf</span><br></pre></td></tr></table></figure><p>登陆任意一台服务器，初始化副本集</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongo 10.253.164.244:27005</span><br><span class="line">#使用admin数据库</span><br><span class="line">use admin</span><br><span class="line">#定义副本集配置</span><br><span class="line">config &#x3D; &#123;</span><br><span class="line">    _id : &quot;shard5&quot;,</span><br><span class="line">     members : [</span><br><span class="line">         &#123;_id : 0, host : &quot;10.253.164.244:27005&quot; &#125;,</span><br><span class="line">         &#123;_id : 1, host : &quot;10.253.173.95:27005&quot; &#125;,</span><br><span class="line">         &#123;_id : 2, host : &quot;10.253.173.108:27005&quot; &#125;</span><br><span class="line">     ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">#初始化副本集配置</span><br><span class="line">rs.initiate(config);</span><br><span class="line"></span><br><span class="line">#查看分区状态</span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure><h1 id="4、配置路由服务器-mongos"><a href="#4、配置路由服务器-mongos" class="headerlink" title="4、配置路由服务器 mongos"></a>4、配置路由服务器 mongos</h1><p>先启动配置服务器和分片服务器,后启动路由实例启动路由实例:10.253.173.95、10.253.173.108</p><p>配置路由服务器：<strong>vi /mnt/mongodb/conf/mongos.conf</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/mnt/mongodb/mongos/log/mongos.log</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">20000</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">10.253</span><span class="number">.164</span><span class="number">.220</span></span><br><span class="line"><span class="comment">#监听的配置服务器,只能有1个或者3个 configs为配置服务器的副本集名字</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">   <span class="attr">configDB:</span> <span class="string">config/10.253.173.95:21000,10.253.173.108:21000,10.253.164.220:21000</span></span><br></pre></td></tr></table></figure><p>启动二台服务器的mongos server</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongos  --config  &#x2F;mnt&#x2F;mongodb&#x2F;conf&#x2F;mongos.conf</span><br></pre></td></tr></table></figure><h1 id="5、启用分片"><a href="#5、启用分片" class="headerlink" title="5、启用分片"></a>5、启用分片</h1><p>目前搭建了mongodb配置服务器、路由服务器，各个分片服务器，不过应用程序连接到mongos路由服务器并不能使用分片机制，还需要在程序里设置分片配置，让分片生效。</p><p>登陆任意一台mongos</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongo 10.253.173.95:20000</span><br><span class="line">#使用admin数据库</span><br><span class="line">use  admin</span><br><span class="line">#串联路由服务器与分配副本集</span><br><span class="line">sh.addShard(&quot;shard1&#x2F;10.253.173.95:27001,10.253.173.108:27001,10.253.164.220:27001&quot;)</span><br><span class="line">sh.addShard(&quot;shard2&#x2F;10.253.173.108:27002,10.253.164.220:27002,10.253.164.242:27002&quot;)</span><br><span class="line">sh.addShard(&quot;shard3&#x2F;10.253.164.220:27003,10.253.164.242:27003,10.253.164.244:27003&quot;)</span><br><span class="line">sh.addShard(&quot;shard4&#x2F;10.253.164.242:27004,10.253.164.244:27004,10.253.173.95:27004&quot;)</span><br><span class="line">sh.addShard(&quot;shard5&#x2F;10.253.164.244:27005,10.253.173.95:27005,10.253.173.108:27005&quot;)</span><br><span class="line">#查看集群状态</span><br><span class="line">sh.status()</span><br></pre></td></tr></table></figure><h1 id="6、测试"><a href="#6、测试" class="headerlink" title="6、测试"></a>6、测试</h1><p>目前配置服务、路由服务、分片服务、副本集服务都已经串联起来了，但我们的目的是希望插入数据，数据能够自动分片。连接在mongos上，准备让指定的数据库、指定的集合分片生效。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mongo  10.253.173.95:20000</span><br><span class="line"><span class="comment">#使用admin</span></span><br><span class="line">use admin;</span><br><span class="line"><span class="comment">#指定testdb分片生效</span></span><br><span class="line">db.runCommand( &#123; enablesharding :<span class="string">"userinfodb"</span>&#125;);</span><br><span class="line"><span class="comment">#指定数据库里需要分片的集合和片键</span></span><br><span class="line">db.runCommand(&#123;shardcollection : <span class="string">"userinfodb.authinfo"</span>,key : &#123;id:1&#125;&#125;)</span><br></pre></td></tr></table></figure><p>我们设置testdb的 table1 表需要分片，根据 id 自动分片到 shard1 ，shard2，shard3，shard4，shard5 上面去。要这样设置是因为不是所有mongodb 的数据库和表 都需要分片！</p><p>测试分片配置结果</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mongo  <span class="number">10.253</span><span class="number">.173</span><span class="number">.95</span>:<span class="number">20000</span></span><br><span class="line">#使用userinfodb</span><br><span class="line">use  userinfodb;</span><br><span class="line">#插入测试数据</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000</span>; i++)db.authinfo.save(&#123;<span class="attr">id</span>:i,<span class="string">"test1"</span>:<span class="string">"testval1"</span>&#125;)</span><br><span class="line">#查看分片情况如下，部分无关信息省掉了</span><br><span class="line">db.authinfo.stats();</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"sharded"</span> : <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"ns"</span> : <span class="string">"testdb.table1"</span>,</span><br><span class="line">        <span class="string">"count"</span> : <span class="number">100000</span>,</span><br><span class="line">        <span class="string">"numExtents"</span> : <span class="number">13</span>,</span><br><span class="line">        <span class="string">"size"</span> : <span class="number">5600000</span>,</span><br><span class="line">        <span class="string">"storageSize"</span> : <span class="number">22372352</span>,</span><br><span class="line">        <span class="string">"totalIndexSize"</span> : <span class="number">6213760</span>,</span><br><span class="line">        <span class="string">"indexSizes"</span> : &#123;</span><br><span class="line">                <span class="string">"_id_"</span> : <span class="number">3335808</span>,</span><br><span class="line">                <span class="string">"id_1"</span> : <span class="number">2877952</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"avgObjSize"</span> : <span class="number">56</span>,</span><br><span class="line">        <span class="string">"nindexes"</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">"nchunks"</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">"shards"</span> : &#123;</span><br><span class="line">                <span class="string">"shard1"</span> : &#123;</span><br><span class="line">                        <span class="string">"ns"</span> : <span class="string">"testdb.table1"</span>,</span><br><span class="line">                        <span class="string">"count"</span> : <span class="number">42183</span>,</span><br><span class="line">                        <span class="string">"size"</span> : <span class="number">0</span>,</span><br><span class="line">                        ...</span><br><span class="line">                        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"shard2"</span> : &#123;</span><br><span class="line">                        <span class="string">"ns"</span> : <span class="string">"testdb.table1"</span>,</span><br><span class="line">                        <span class="string">"count"</span> : <span class="number">38937</span>,</span><br><span class="line">                        <span class="string">"size"</span> : <span class="number">2180472</span>,</span><br><span class="line">                        ...</span><br><span class="line">                        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"shard3"</span> : &#123;</span><br><span class="line">                        <span class="string">"ns"</span> : <span class="string">"testdb.table1"</span>,</span><br><span class="line">                        <span class="string">"count"</span> :<span class="number">18880</span>,</span><br><span class="line">                        <span class="string">"size"</span> : <span class="number">3419528</span>,</span><br><span class="line">                        ...</span><br><span class="line">                        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到数据分到3个分片，各自分片数量为： shard1 “count” : 42183，shard2 “count” : 38937，shard3 “count” : 18880。已经成功了！</p><h1 id="7、创建认证用户"><a href="#7、创建认证用户" class="headerlink" title="7、创建认证用户"></a>7、创建认证用户</h1><h2 id="7-1-首先建立一个拥有添加删除用户权限的账号"><a href="#7-1-首先建立一个拥有添加删除用户权限的账号" class="headerlink" title="7.1 首先建立一个拥有添加删除用户权限的账号"></a>7.1 首先建立一个拥有添加删除用户权限的账号</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">db.createUser(&#123;</span><br><span class="line">    user:<span class="string">"useradmin"</span>,</span><br><span class="line">    pwd:<span class="string">"123456"</span>,</span><br><span class="line">    roles: [ &#123; <span class="attr">role</span>: <span class="string">"userAdminAnyDatabase"</span>,<span class="attr">db</span>:<span class="string">"admin"</span>&#125;,</span><br><span class="line">    &#123; <span class="attr">role</span> : <span class="string">"clusterAdmin"</span>, <span class="attr">db</span> : <span class="string">"admin"</span> &#125; </span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line">db.auth(<span class="string">"useradmin"</span>,<span class="string">"123456"</span>)<span class="comment">//认证该用户</span></span><br></pre></td></tr></table></figure><p>这里就添加了一个useradmin这么一个用户，他可以进行所有数据库的用户管理。在添加这个用户后，我们连接mongodb时仍然不需要进行登录，这是因为我们未在配置中开启权限验证。</p><h2 id="7-2-开启分片集群的权限验证"><a href="#7-2-开启分片集群的权限验证" class="headerlink" title="7.2.开启分片集群的权限验证"></a>7.2.开启分片集群的权限验证</h2><h3 id="7-2-1-首先生成一个添加keyFile文件—–-gt-用于认证使用"><a href="#7-2-1-首先生成一个添加keyFile文件—–-gt-用于认证使用" class="headerlink" title="7.2.1 首先生成一个添加keyFile文件—–&gt;用于认证使用"></a>7.2.1 首先生成一个添加keyFile文件—–&gt;用于认证使用</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">openssl rand -base64 753 &gt;mongodb-keyfile</span><br><span class="line">mkdir -p /mnt/mongodb/key/</span><br><span class="line">cp mongodb-keyfile /mnt/mongodb/key/</span><br><span class="line">chmod 600 /mnt/mongodb/key/mongodb-keyfile</span><br></pre></td></tr></table></figure><p>复制mongodb-keyfile文件到其他集群<br></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">scp /mnt/mongodb/key/mongodb-keyfile root@10.253.173.95:/mnt/mongodb/key/</span><br></pre></td></tr></table></figure><p></p><h3 id="7-2-2-在各个分片以及configserver的配置文件中加上如下语句"><a href="#7-2-2-在各个分片以及configserver的配置文件中加上如下语句" class="headerlink" title="7.2.2 在各个分片以及configserver的配置文件中加上如下语句"></a>7.2.2 在各个分片以及configserver的配置文件中加上如下语句</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#开启权限验证</span></span><br><span class="line">security:</span><br><span class="line">    authorization: enabled</span><br><span class="line">    keyFile: /mnt/mongodb/key/mongodb-keyfile</span><br></pre></td></tr></table></figure><h3 id="7-2-3-在每台机器上的mongos配置文件中加入下面一段配置"><a href="#7-2-3-在每台机器上的mongos配置文件中加入下面一段配置" class="headerlink" title="7.2.3 在每台机器上的mongos配置文件中加入下面一段配置"></a>7.2.3 在每台机器上的mongos配置文件中加入下面一段配置</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#开启权限验证</span></span><br><span class="line">security:</span><br><span class="line">    keyFile: /mnt/mongodb/key/mongodb-keyfile</span><br></pre></td></tr></table></figure><h1 id="8、启动关闭"><a href="#8、启动关闭" class="headerlink" title="8、启动关闭"></a>8、启动关闭</h1><p>mongodb的启动顺序是，先启动配置服务器，在启动分片，最后启动mongos.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mongod -f /mnt/mongodb/conf/config.conf</span><br><span class="line">mongod -f /mnt/mongodb/conf/shard1.conf</span><br><span class="line">mongod -f /mnt/mongodb/conf/shard2.conf</span><br><span class="line">mongod -f /mnt/mongodb/conf/shard3.conf</span><br><span class="line">mongos  --config  /mnt/mongodb/conf/mongos.conf</span><br></pre></td></tr></table></figure><p>关闭时，直接killall杀掉所有进程</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">killall mongod</span><br><span class="line">killall mongos</span><br></pre></td></tr></table></figure><h1 id="9、用户权限"><a href="#9、用户权限" class="headerlink" title="9、用户权限"></a>9、用户权限</h1><h2 id="9-1、创建用户"><a href="#9-1、创建用户" class="headerlink" title="9.1、创建用户"></a>9.1、创建用户</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.createUser(&#123;<span class="attr">user</span>:<span class="string">'superadmin'</span>,<span class="attr">pwd</span>:<span class="string">'123456'</span>, <span class="attr">roles</span>:[&#123;<span class="attr">role</span>:<span class="string">'root'</span>, <span class="attr">db</span>:<span class="string">'admin'</span>&#125;]&#125;)     ---创建超级管理员用户</span><br><span class="line"> </span><br><span class="line">db.createUser(&#123;<span class="attr">user</span>:<span class="string">'useradmin'</span>,<span class="attr">pwd</span>:<span class="string">'123456'</span>, <span class="attr">roles</span>:[&#123;<span class="attr">role</span>:<span class="string">'userAdminAnyDatabase'</span>, <span class="attr">db</span>:<span class="string">'admin'</span>&#125;]&#125;)     ---创建用户管理员账户（能查询其他库集合，但不能查询集合内容）</span><br><span class="line"> </span><br><span class="line">db.createUser(&#123;<span class="attr">user</span>:<span class="string">'admin'</span>,<span class="attr">pwd</span>:<span class="string">'123456'</span>, <span class="attr">roles</span>:[&#123;<span class="attr">role</span>:<span class="string">'readWriteAnyDatabase'</span>, <span class="attr">db</span>:<span class="string">'admin'</span>&#125;]&#125;)     ---创建访问任意库读写的账户</span><br><span class="line"> </span><br><span class="line">db.createUser(&#123;<span class="attr">user</span>:<span class="string">'user1'</span>,<span class="attr">pwd</span>:<span class="string">'user1'</span>,<span class="attr">roles</span>:[&#123;<span class="attr">role</span>:<span class="string">'readWrite'</span>,<span class="attr">db</span>:<span class="string">'test'</span>&#125;]&#125;)     ---创建只对test库有读写权限的用户</span><br><span class="line"> </span><br><span class="line">db.createUser(&#123;<span class="attr">user</span>:<span class="string">"bkuser2"</span>,<span class="attr">pwd</span>:<span class="string">"Bkuser2"</span>,<span class="attr">roles</span>:[&#123;<span class="attr">role</span>:<span class="string">"backup"</span>,<span class="attr">db</span>:<span class="string">"admin"</span>&#125;]&#125;)     ---创建用于备份时的用户，如若是恢复权限，则将backup换为restore即可</span><br></pre></td></tr></table></figure><h2 id="9-2、用户查询"><a href="#9-2、用户查询" class="headerlink" title="9.2、用户查询"></a>9.2、用户查询</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;use admin</span><br><span class="line">&gt;db.system.users.find().pretty()          ---将所有用户信息查询出来</span><br><span class="line"></span><br><span class="line">显示某一库下的所有用户</span><br><span class="line">&gt;use <span class="built_in">test</span></span><br><span class="line">&gt;show users                              ---显示在此库授权的用户信息</span><br></pre></td></tr></table></figure><h2 id="9-3、修改用户权限"><a href="#9-3、修改用户权限" class="headerlink" title="9.3、修改用户权限"></a>9.3、修改用户权限</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">db.updateUser(<span class="string">"root"</span>,</span><br><span class="line">    &#123;<span class="attr">roles</span>:[&#123;<span class="attr">role</span>:<span class="string">"readWriteAnyDatabase"</span>,</span><br><span class="line">    db:<span class="string">"admin"</span>&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在原来权限上新增权限</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">db.grantRolesToUser(<span class="string">"jianlong"</span>,[&#123;<span class="attr">role</span>:<span class="string">'readWrite'</span>,<span class="attr">db</span>:<span class="string">'test'</span>&#125;])     ---不会覆盖原权限信息，只新增权限</span><br></pre></td></tr></table></figure><h2 id="9-4、修改用户密码"><a href="#9-4、修改用户密码" class="headerlink" title="9.4、修改用户密码"></a>9.4、修改用户密码</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">db.changeUserPassword(<span class="string">"tuser"</span>,<span class="string">"123456"</span>)</span><br></pre></td></tr></table></figure><h2 id="9-5、删除用户"><a href="#9-5、删除用户" class="headerlink" title="9.5、删除用户"></a>9.5、删除用户</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.system.users.remove(&#123;user:&quot;tuser&quot;&#125;);</span><br></pre></td></tr></table></figure><h1 id="10、mongodb常用数据库命令"><a href="#10、mongodb常用数据库命令" class="headerlink" title="10、mongodb常用数据库命令"></a>10、mongodb常用数据库命令</h1><h2 id="10-1、数据库操作"><a href="#10-1、数据库操作" class="headerlink" title="10.1、数据库操作"></a>10.1、数据库操作</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">show dbs;<span class="comment">#查看数据库</span></span><br><span class="line">use <span class="built_in">test</span>;<span class="comment">#如果没有就创建一个</span></span><br><span class="line">db;<span class="comment">#查看当前数据库</span></span><br><span class="line">db.dropDatabase();<span class="comment">#删除数据库</span></span><br></pre></td></tr></table></figure><h2 id="10-2、数据操作"><a href="#10-2、数据操作" class="headerlink" title="10.2、数据操作"></a>10.2、数据操作</h2><p><strong>插入</strong></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">show collections；<span class="comment">#查看集合</span></span><br><span class="line">create collection;<span class="comment">#创建集合</span></span><br><span class="line">db.student.insert(&#123;<span class="string">"name"</span>:<span class="string">"张三"</span>,<span class="string">"age"</span>:<span class="string">"22"</span>,<span class="string">"sex"</span>:<span class="string">"男"</span>,<span class="string">"class"</span>:<span class="string">"计算机2班"</span>&#125;);<span class="comment">#如果数据库中不存在集合，就创建并插入这些数据</span></span><br><span class="line">db.student.insert(&#123;<span class="string">"name"</span>:<span class="string">"李四"</span>,<span class="string">"age"</span>:<span class="string">"22"</span>,<span class="string">"sex"</span>:<span class="string">"女"</span>,<span class="string">"phone"</span>:<span class="string">"18513081650"</span>,<span class="string">"class"</span>:<span class="string">"计算机1班"</span>&#125;);<span class="comment">#里面的key-value不用保持一致</span></span><br><span class="line">db.student.insert([&#123;<span class="string">"name"</span>:<span class="string">"王五"</span>,<span class="string">"age"</span>:<span class="string">"22"</span>,<span class="string">"sex"</span>:<span class="string">"男"</span>,<span class="string">"class"</span>:<span class="string">"计算机2班"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"赵六"</span>,<span class="string">"age"</span>:<span class="string">"22"</span>,<span class="string">"sex"</span>:<span class="string">"女"</span>,<span class="string">"phone"</span>:<span class="string">"18513081650"</span>,<span class="string">"class"</span>:<span class="string">"计算机1班"</span>&#125;]);<span class="comment">#同时插入多条数据</span></span><br></pre></td></tr></table></figure><p><strong>更新</strong></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.student.update(&#123;"name":"张三"&#125;,&#123;"name":"张三丰"&#125;);#如果有多条语句，只修改第一条，会覆盖原有数据</span><br><span class="line">db.student.update(&#123;<span class="string">"22"</span>:<span class="string">"女"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"张三丰"</span>&#125;);</span><br><span class="line">db.student.update(&#123;"name":"张三"&#125;,&#123;$set:&#123;"name":"张无忌"&#125;&#125;);#只想改某个key的value使用set</span><br><span class="line">db.student.update(&#123;"name":"王五"&#125;,&#123;$set:&#123;"name":"张无忌"&#125;&#125;,&#123;multi:true&#125;);#把所有的记录都改了</span><br></pre></td></tr></table></figure><p><strong>查询</strong></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.student.find();#查询全部</span><br><span class="line">db.student.find(&#123;"name":"李四"&#125;);#查询指定记录，返回这一行结果</span><br><span class="line">db.student.update(&#123;<span class="string">"name"</span>:<span class="string">"张三丰"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"张无忌"</span>,<span class="string">"age"</span>:<span class="string">"28"</span>,<span class="string">"sex"</span>:<span class="string">"男"</span>&#125;);</span><br><span class="line">db.student.find(&#123;"name":"张无忌","age":"28"&#125;);#and操作</span><br><span class="line">db.student.find(&#123;$or:[&#123;"name":"张无忌"&#125;,&#123;"name":"李四"&#125;]&#125;);#or操作</span><br><span class="line">db.student.find().pretty();#格式化显示</span><br><span class="line">db.student.find().count();#获取结果的行数</span><br><span class="line">db.student.find().sort(&#123;"age":-1&#125;);#按照sort里面key的值排序，1为正序，-1为倒序</span><br></pre></td></tr></table></figure><p><strong>删除</strong></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.student.remove();#删除所有数据</span><br><span class="line">db.student.remove(&#123;"22":"女"&#125;);#按照条件删除</span><br><span class="line">db.student.remove(&#123;"name":"张无忌"&#125;,2);#删除几条</span><br></pre></td></tr></table></figure></div><div class="meta split"> <span>本文总阅读量<span id="busuanzi_value_page_pv"></span> 次</span> <time class="post-date" datetime="2020-04-18T07:01:23.084Z" itemprop="datePublished">2020-04-18</time></div></article></div><svg id="bigTriangleColor" width="100%" height="40" viewBox="0 0 100 102" preserveAspectRatio="none"><path d="M0 0 50 100 100 0Z"></path></svg><div class="wrapper"></div><div class="fat-footer"><div class="wrapper"><div class="layout layout--center"><div class="layout__item palm-mb"><div class="media"> <img class="headimg" src="http://img.matosiki.site/avatar.jpg" alt="iki"><div class="media__body"><h4>不积跬步无以至千里</h4><p class="site-description">我不会下写诗,但我写的代码像诗一样优雅.</p></div></div><div class="author-contact"><ul><li><a href="https://weibo.com/u/5212711259" target="_blank"><i class="iconfont icon-weibo"></i></a></li><li><a href="https://github.com/wx11055" target="_blank"><i class="iconfont icon-github"></i></a></li><li><a href="https://www.zhihu.com/" target="_blank"><i class="iconfont icon-zhihu"></i></a></li></ul></div></div><div class="layout__item palm-mt"><div class="media__body"></div><p class="site-description">©️2019-2020 matosiki.site 版权所有.ICP证:鄂ICP备16003435号</p></div></div></div></div><footer class="footer" role="contentinfo"><div class="wrapper wrapper--wide split split--responsive"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次, 访客数<span id="busuanzi_value_site_uv"></span></span></div></footer><script src="../../../js/lib.js"></script><script src="../../../js/google-code-prettify/prettify.js"></script><script src="../../../js/module.js"></script><script src="../../../js/script.js"></script><script src="../../../assets/algolia/algoliasearch.min.js"></script><script src="../../../http:/cdn.bootcss.com/instantsearch.js/1.7.1/instantsearch.min.js"></script><script src="../../../js/search.js"></script><script src="../../../http:/cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script><script type="text/javascript">$(document).ready(function(){$("pre").addClass("prettyprint linenums").attr("style","overflow:auto;"),prettyPrint()})</script></body></html>